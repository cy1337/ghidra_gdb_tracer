import gdb

gdb.execute('set logging off')
gdb.execute('set logging file ./gdb_trace_log.txt')
gdb.execute('set logging on')
gdb.execute('set pagination off')
class FunctionBreakpoint(gdb.Breakpoint):
    def __init__(self, location, func_name):
        location += base_addr
        bp_loc = '*{}'.format(hex(location))
        super(FunctionBreakpoint, self).__init__(bp_loc, gdb.BP_BREAKPOINT, internal=False)
        self.func_name = func_name

    def stop(self):
        gdb.write('Function: {}\n'.format(self.func_name))
        gdb.execute('disable breakpoints {}'.format(self.number))
        return False

def set_base_address():
    gdb.execute('starti')
    gdb.execute('set $base_addr = read - 0x134610')
    base_addr = int(gdb.parse_and_eval('$base_addr'))
    gdb.write('Base address set to: {:#x}\n'.format(base_addr))
    return base_addr

base_addr = set_base_address()

FunctionBreakpoint(0x134000, '_DT_INIT')
FunctionBreakpoint(0x134020, 'FUN_00134020')
FunctionBreakpoint(0x1343d0, '__cxa_finalize')
FunctionBreakpoint(0x1343e0, 'printf')
FunctionBreakpoint(0x1343f0, 'pclose')
FunctionBreakpoint(0x134400, 'memcpy')
FunctionBreakpoint(0x134410, '__isoc99_sscanf')
FunctionBreakpoint(0x134420, 'EVP_PKEY_free')
FunctionBreakpoint(0x134430, 'cJSON_Parse')
FunctionBreakpoint(0x134440, '__ctype_b_loc')
FunctionBreakpoint(0x134450, 'setsockopt')
FunctionBreakpoint(0x134460, 'strncpy')
FunctionBreakpoint(0x134470, 'toupper')
FunctionBreakpoint(0x134480, 'free')
FunctionBreakpoint(0x134490, 'cJSON_GetArrayItem')
FunctionBreakpoint(0x1344a0, 'close')
FunctionBreakpoint(0x1344b0, '__stack_chk_fail')
FunctionBreakpoint(0x1344c0, 'perror')
FunctionBreakpoint(0x1344d0, 'memset')
FunctionBreakpoint(0x1344e0, 'atoi')
FunctionBreakpoint(0x1344f0, 'regcomp')
FunctionBreakpoint(0x134500, 'cJSON_Delete')
FunctionBreakpoint(0x134510, 'send')
FunctionBreakpoint(0x134520, 'strlen')
FunctionBreakpoint(0x134530, 'regfree')
FunctionBreakpoint(0x134540, 'socket')
FunctionBreakpoint(0x134550, 'strstr')
FunctionBreakpoint(0x134560, 'snprintf')
FunctionBreakpoint(0x134570, 'CRYPTO_free')
FunctionBreakpoint(0x134580, 'BIO_free')
FunctionBreakpoint(0x134590, 'shutdown')
FunctionBreakpoint(0x1345a0, 'xmlNodeGetContent')
FunctionBreakpoint(0x1345b0, 'fgets')
FunctionBreakpoint(0x1345c0, 'exit')
FunctionBreakpoint(0x1345d0, 'strcat')
FunctionBreakpoint(0x1345e0, 'htons')
FunctionBreakpoint(0x1345f0, 'qsort')
FunctionBreakpoint(0x134600, 'xmlParseMemory')
FunctionBreakpoint(0x134610, 'read')
FunctionBreakpoint(0x134620, 'strncat')
FunctionBreakpoint(0x134630, 'cJSON_GetObjectItemCaseSensitive')
FunctionBreakpoint(0x134640, 'popen')
FunctionBreakpoint(0x134650, 'strcmp')
FunctionBreakpoint(0x134660, 'accept')
FunctionBreakpoint(0x134670, 'tolower')
FunctionBreakpoint(0x134680, 'xmlDocGetRootElement')
FunctionBreakpoint(0x134690, 'malloc')
FunctionBreakpoint(0x1346a0, 'BIO_new_mem_buf')
FunctionBreakpoint(0x1346b0, 'bind')
FunctionBreakpoint(0x1346c0, 'PEM_read_bio_PUBKEY')
FunctionBreakpoint(0x1346d0, 'xmlGetProp')
FunctionBreakpoint(0x1346e0, 'puts')
FunctionBreakpoint(0x1346f0, 'sprintf')
FunctionBreakpoint(0x134700, 'regexec')
FunctionBreakpoint(0x134710, 'CRYPTO_malloc')
FunctionBreakpoint(0x134720, 'ntohs')
FunctionBreakpoint(0x134730, 'listen')
FunctionBreakpoint(0x134740, 'xmlFreeDoc')
FunctionBreakpoint(0x134750, 'strtod')
FunctionBreakpoint(0x134760, 'ERR_print_errors_fp')
FunctionBreakpoint(0x134770, 'i2d_PublicKey')
FunctionBreakpoint(0x134780, 'entry')
FunctionBreakpoint(0x1347b0, 'FUN_001347b0')
FunctionBreakpoint(0x1347e0, 'FUN_001347e0')
FunctionBreakpoint(0x134820, '_FINI_0')
FunctionBreakpoint(0x134860, '_INIT_0')
FunctionBreakpoint(0x134869, 'FUN_00134869')
FunctionBreakpoint(0x1349b0, 'FUN_001349b0')
FunctionBreakpoint(0x134a1e, 'FUN_00134a1e')
FunctionBreakpoint(0x134adb, 'FUN_00134adb')
FunctionBreakpoint(0x134c1b, 'FUN_00134c1b')
FunctionBreakpoint(0x134ee5, 'FUN_00134ee5')
FunctionBreakpoint(0x135309, 'FUN_00135309')
FunctionBreakpoint(0x1353f3, 'FUN_001353f3')
FunctionBreakpoint(0x135446, 'FUN_00135446')
FunctionBreakpoint(0x135550, 'FUN_00135550')
FunctionBreakpoint(0x135857, 'FUN_00135857')
FunctionBreakpoint(0x13591b, 'FUN_0013591b')
FunctionBreakpoint(0x135d45, 'FUN_00135d45')
FunctionBreakpoint(0x135e72, 'FUN_00135e72')
FunctionBreakpoint(0x136234, 'FUN_00136234')
FunctionBreakpoint(0x1362dd, 'FUN_001362dd')
FunctionBreakpoint(0x136627, 'FUN_00136627')
FunctionBreakpoint(0x13672b, 'FUN_0013672b')
FunctionBreakpoint(0x136805, 'FUN_00136805')
FunctionBreakpoint(0x13685b, 'FUN_0013685b')
FunctionBreakpoint(0x1369c8, 'FUN_001369c8')
FunctionBreakpoint(0x136a55, 'FUN_00136a55')
FunctionBreakpoint(0x136d20, 'FUN_00136d20')
FunctionBreakpoint(0x136d90, 'FUN_00136d90')
FunctionBreakpoint(0x136d98, '_DT_FINI')
gdb.execute('continue')
